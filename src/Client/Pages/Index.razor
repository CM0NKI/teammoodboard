@page "/"
@page "/{moodboardIdParameter}"
@using MoodBoard.Shared;
@using MoodBoard.Models;
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

@if (showPage)
{
    <div class="container">
        @foreach (var topic in configuration)
        {
            <div class="topic">@topic.Name <span class="voteCount">@GetVoteCountForTopic(topic.Id)</span></div>
            @foreach (var option in topic.VoteOptions)
            {
                <div>
                @if (votingClosed)
                {
                    var voteCountForOption = GetVoteCountForOption(topic.Id, option.Id);
                    <div class="icon @(voteCountForOption > 0 ? "winner" : "loser")">
                        @option.Emoji <span class="voteCount">@voteCountForOption</span>
                    </div>
                }
                else
                {
                    <div class="icon @(AlreadyVotedCheck(option.Id, topic.Id) ? "voted" : "")" 
                        @onclick="() => ProcessVote(option.Id, topic)">@option.Emoji <span class="voteCount placeholder">?</span>
                    </div>                
                }
                </div>
            }
        }
    </div>
    @if (votedOnAllTopics && !votingClosed)
    {
        <button class="button" @onclick="ShowResults">Click to see team results!</button>
    }        
}

@code {
    [Parameter]
    public string moodboardIdParameter { get; set; }

    private List<Vote> votes = new List<Vote>();
    private bool showPage = false;
    private Guid moodboardId;
    private List<VoteTopic> configuration;
    private HubConnection voteHub;
    private Guid sessionId = Guid.NewGuid();
    private bool votedOnAllTopics = false;
    private bool votingClosed = false;

    protected override async Task OnInitializedAsync()
    {
        GenerateNewMoodboardIdIfNoValidIdFound();
        InitializeVotingTopics();
        await RegisterWithServer();
        await GetVotesFromServer();
        showPage = true;
    }

    void InitializeVotingTopics()
    {
        //Voting topics can be added without other changes
        //For additional voting options changes are needed

        this.configuration = new List<VoteTopic> {
            new VoteTopic(1, "Team", new List<VoteOption> {
                new VoteOption(1, "🤠"),
                new VoteOption(2, "🙂"),
                new VoteOption(3, "😭")
            }),
            new VoteTopic(2, "Process", new List<VoteOption> {
                new VoteOption(1, "🤠"),
                new VoteOption(2, "🙂"),
                new VoteOption(3, "😭")
            }),
            new VoteTopic(3, "End result", new List<VoteOption> {
                new VoteOption(1, "🤠"),
                new VoteOption(2, "🙂"),
                new VoteOption(3, "😭")
            }),
            new VoteTopic(4, "How I felt", new List<VoteOption> {
                new VoteOption(1, "😎"),
                new VoteOption(2, "😖"),
                new VoteOption(3, "😤")
            })
        };
    }

    void GenerateNewMoodboardIdIfNoValidIdFound()
    {
        bool validGuidFound = Guid.TryParse(this.moodboardIdParameter, out this.moodboardId);

        if (!validGuidFound)
        {
            var newMoodboardId = Guid.NewGuid();
            NavigationManager.NavigateTo($"/{newMoodboardId}");
            this.moodboardId = newMoodboardId;
        }
    }

    async Task RegisterWithServer() {
        voteHub = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/votehub"))
            .Build();
        voteHub.On<List<Vote>>("ReceiveVotes", (votes) => ProcessReceivedVotes(votes));
        await voteHub.StartAsync();        
        await voteHub.InvokeAsync("AddClientToMoodboard", this.moodboardId);
    }

    void ShowResults()
    {
        votingClosed = true;
    }

    void VotedOnAllTopicsCheck()
    {
        if (votes
                .Count(vote => vote.sessionId == sessionId)
                .Equals(configuration.Count()))
        {
            votedOnAllTopics = true;
        }
    }

    void ProcessReceivedVotes(List<Vote> votes)
    {
        this.votes = votes;
        VotedOnAllTopicsCheck();
        StateHasChanged();
    }

    int GetVoteCountForTopic(int topicId)
    {
        return votes.Count(vote => vote.topicId == topicId);
    }    

    int GetVoteCountForOption(int topicId, int optionId)
    {
        return votes.Count(vote => vote.topicId == topicId && vote.VoteId == optionId); 
    }

    bool AlreadyVotedCheck(int voteId, int topicId)
    {
        return votes.Any(vote => 
            vote.sessionId == sessionId
            && vote.topicId == topicId
            && vote.VoteId == voteId);        
    }

    Task ProcessVote(int voteId, VoteTopic topic) =>
        voteHub.SendAsync("ProcessVote", new Vote(moodboardId, topic.Id, voteId, sessionId));

    Task GetVotesFromServer() =>
        voteHub.InvokeAsync("SendUpdateToAllClients", this.moodboardId);

    public ValueTask DisposeAsync() =>
        voteHub.DisposeAsync();
}